<program-wizard *ngIf="loaded && !hasError" [showNext]="nextStep" [skipTo]="jumpStep" [showPrev]="prevStep" (onStepChanged)="resetNext()">
  <program-wizard-header [customClass]="customTitleClass" [currentStep]="currentStep" [steps]="steps" [title]="title"></program-wizard-header>
  <program-wizard-step [name]="'Department Step'">
    <div class="wizard-body component">
      <div class="step" *ngIf="programDepartments">
        <div class="step-name">
          <h2><i class="fa fa-arrow-right"></i> Select Department </h2>
        </div>
        <div class="step-details">
          <p class="alert alert-danger" *ngIf="hasValidationErrors">
            {{currentError}}
          </p>
          <p class="checkbox-container-" *ngFor="let _department of programDepartments">
            <input name="department" [ngModel]="department" value="{{_department.name}}" (ngModelChange)="selectDepartment($event)" type="radio">
            {{_department.name}}
          </p>
        </div>
        <div class="step-buttons">
          <button type="button" class="btn btn-secondary pull-right"
                  (click)="gotToProgram()">Continue</button>
        </div>
      </div>
    </div>
  </program-wizard-step>
  <program-wizard-step [name]="'Program Selection Step'" >
    <div class="wizard-body component">
      <div class="step" *ngIf="availableDepartmentPrograms">
        <div class="step-name">
          <h2><i class="fa fa-arrow-right"></i> Select Program </h2>
        </div>
        <div class="step-details">
            <p class="checkbox-container-" *ngFor="let _program of availableDepartmentPrograms">
              <input name="department" [ngModel]="program" (ngModelChange)="selectProgram($event)" value="{{_program.uuid}}" type="radio">
              {{_program.name}}
            </p>
        </div>
        <div class="step-buttons">
          <button type="button" class="btn btn-danger pull-left"
                  (click)="back()">Back</button>
          <button type="button" class="btn btn-primary pull-right"
                  (click)="gotToDetails()">Continue</button>
        </div>
      </div>
    </div>
  </program-wizard-step>
  <program-wizard-step [name]="'Program Incompatibility Step'">
    <div class="wizard-body component">
      <div class="step" *ngIf="programIncompatible">
        <div class="step-name">
          <h2><i class="fa fa-arrow-right"></i>Program Incompatibility</h2>
        </div>
        <div class="step-details">
              <unenroll-patient-programs [enrollments]="incompatibleProgrames"
                                         [reason]="reasonForUnenroll"
                                         [modal]="false"
                                         [patient]="patient"
                                         [unenrollExpressely] = "unenrollExpressely"
                                         [encounterTypeFilter]="unenrollmentForms"
                                         (unenrollmentCompleted)="completeIncompatibilityStep($event)"
                                         (unEnrollmentCancelled)="onUnenrollmentCancel($event)"
              ></unenroll-patient-programs>
        </div>
      </div>
    </div>
  </program-wizard-step>
  <program-wizard-step [name]="'Program Details Step'">
    <div class="wizard-body component">
      <div class="step" *ngIf="selectedProgram">
        <busy *ngIf="enrolling" [message]="'Enrolling patient'"></busy>
        <div class="step-name">
          <h2>{{selectedProgram.program._openmrsModel.display}}<span class="text-info" *ngIf="isReferral">(as a referral)</span> </h2>
        </div>
        <div class="step-details">
          <div class="program-body">
            <p class="alert alert-danger" *ngIf="hasValidationErrors">
              {{currentError}}
            </p>
            <div class="program-container-fluid">
              <div class="row" style="padding:4px">
                  <div style="margin-bottom: 12px;" class="col-md-4 cell"
                       *ngFor="let question of requiredProgramQuestions">
                    <label>{{question.name}}</label>
                    <select class="form-control" id="{{question.qtype}}" [(ngModel)]="question.value"
                            (change)="onRequiredQuestionChange($event)">
                      <option value=""></option>
                      <ng-container *ngFor="let answer of question.answers">
                        <option value="{{answer.value}}">
                          {{answer.label}}
                        </option>
                      </ng-container>
                    </select>
                  </div>
                <div style="margin-bottom: 12px;" class="col-md-4 cell">
                  <label for="enrolledDate">Date Enrolled</label>
                  <div>
                    <input class="form-control" id="enrolledDate" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}"
                           [ngModel]="dateEnrolled" (ngModelChange)="saveEnrollmentDate($event)" [max]="maxDate" type="date"/>
                  </div>
                </div>
                <div class="col-md-4 col-xs-12 cell">
                  <location-filter (onLocationChange)="getSelectedLocation($event)"
                                   [disable-county]="true"></location-filter>
                </div>
              </div>
            </div>
            <ng-container *ngIf="showForms">
              <p>Please fill the following required forms to enroll the patient</p>
              <form-list (onFormSelected)="fillEnrollmentForm($event)" [showFilter]="false" [encounterTypeFilter]="enrollmentEncounters"></form-list>
            </ng-container>
          </div>
        </div>
        <div class="step-buttons">
          <button *ngIf="!isReferral" type="button" class="btn btn-danger pull-left"
                  (click)="goBack()">Back</button>
          <button *ngIf="!showForms" class="btn pull-right" (click)="showEnrollmentFormsOrEnrollOnValidation()">
            <span *ngIf="isReferral">Refer</span>
            <span *ngIf="!isReferral">Enroll</span>
          </button>
        </div>
      </div>
    </div>
  </program-wizard-step>
  <program-wizard-step [name]="'Program Enrollment Success'">
    <div class="wizard-body component">
      <div class="step">
        <div style="margin-bottom: 20px;" class="alert alert-success" *ngIf="newlyEnrolledProgram && !isReferral">
          <div class="step-name">
            <h3 style="margin-top: 0; margin-bottom: 0;">{{newlyEnrolledProgram.display}}</h3>
          </div>
          <div class="step-details">
            <div class="program-body">
              <h3>1. Location</h3>
              <p><strong>{{newlyEnrolledProgram.location?.display}}</strong></p>
              <h3>2. Start Date</h3>
              <p><strong>{{newlyEnrolledProgram?.dateEnrolled | date: 'longDate'}}</strong></p>
              <ng-container *ngIf="newlyEnrolledProgram.formFilled">
                <h3>3. Forms Completed</h3>
                <p><strong>{{newlyEnrolledProgram.formFilled}}</strong></p>
              </ng-container>

            </div>
          </div>
        </div>
        <div style="margin-bottom: 20px;background-color: #d9edf7 !important;" class="alert alert-info" *ngIf="newlyEnrolledProgram && isReferral">
          <div class="step-name">
            <h3 style="margin-top: 0; margin-bottom: 0;"><strong>REFERRAL: </strong>{{newlyEnrolledProgram.display}}</h3>
          </div>
          <div class="step-details">
            <div class="program-body">
              <h3>Location Referred To: <strong>{{newlyEnrolledProgram.location?.display}}</strong></h3>
              <h3>Referral Date <strong>{{newlyEnrolledProgram?.dateEnrolled | date: 'longDate'}}</strong></h3>
              <ng-container *ngIf="newlyEnrolledProgram.formFilled">
                <h3>Referral Form: <strong>{{newlyEnrolledProgram.formFilled}}</strong></h3>
              </ng-container>
            </div>
          </div>
        </div>
        <ng-container *ngIf="incompatibleProgrames.length > 0">
            <h2 class="component-title">Programs Sucessfully Stopped</h2>
          <div class="alert alert-danger" *ngFor="let program of incompatibleProgrames">
            <div class="step-name">
              <h3 style="margin-top: 0;">{{program.name}}</h3>
            </div>
            <div class="step-details">
              <div class="program-body">
                <h3>Started: <strong>{{program.enrolledDate | date: 'longDate'}}</strong></h3>
                <h3>Stopped: <strong>{{ today | date: 'longDate'}}</strong></h3>
                <ng-container *ngIf="program.formFilled">
                  <h3>Forms Completed</h3>
                  <h4 style="margin-bottom: 0;"><strong>{{program.formFilled}}</strong></h4>
                </ng-container>
              </div>
            </div>
          </div>
        </ng-container>
        <div class="step-buttons">
          <button type="button" class="btn btn-danger pull-left"
                  (click)="editProgram(newlyEnrolledProgram)">Edit Program</button>
          <button class="btn btn-primary pull-right" (click)="goToProgramSummary()">
            <span>GO TO PROGRAM SUMMARY</span>
          </button>
        </div>
      </div>
    </div>
  </program-wizard-step>
</program-wizard>
<busy *ngIf="!loaded" [message]="'Loading...'"></busy>
<busy *ngIf="refreshingPatient" [message]="'Refreshing Patient Info...'"></busy>
<p class="alert alert-danger" *ngIf="hasError">
  Error loading patient program config. Please make sure that your network is working fine.
</p>
